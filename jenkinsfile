cat > Jenkinsfile << 'EOF'
pipeline {
    agent any
    
    environment {
        REPO_URL = 'https://github.com/citrasn/citrasn.git'
        BUILD_TIME = sh(script: 'date +"%Y-%m-%d %H:%M:%S"', returnStdout: true).trim()
    }
    
    stages {
        stage('1. Checkout & Setup') {
            steps {
                echo 'üöÄ ================================'
                echo 'üöÄ CI/CD PIPELINE - WINDOWS'
                echo 'üöÄ ================================'
                echo 'üìå Repository: citrasn/citrasn'
                echo 'üìå OS: Windows'
                echo 'üìå Time: ' + env.BUILD_TIME
                
                // Checkout code
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/citrasn/citrasn.git'
                    ]],
                    extensions: [[$class: 'CleanBeforeCheckout']]
                ])
                
                // List files using Windows command
                bat '''
                    echo ================================
                    echo FILES IN WORKSPACE
                    echo ================================
                    dir /B
                    echo ================================
                '''
            }
        }
        
        stage('2. Create PHP Files') {
            steps {
                echo 'üìù CREATING PHP FILES FOR TUGAS 2...'
                
                // Create index.php using bat (Windows)
                bat '''
                    echo ^<?php > index.php
                    echo // ========================================= >> index.php
                    echo // CI/CD PIPELINE - TUGAS 2 >> index.php
                    echo // Repository: citrasn/citrasn >> index.php
                    echo // ========================================= >> index.php
                    echo echo "=================================\\n"; >> index.php
                    echo echo "     JENKINS CI/CD PIPELINE\\n"; >> index.php
                    echo echo "=================================\\n"; >> index.php
                    echo echo "Tugas 2: Run PHP Script\\n"; >> index.php
                    echo echo "Command: powershell \\"php index.php\\"\\n"; >> index.php
                    echo echo "Status: EXECUTING...\\n"; >> index.php
                    echo echo "\\n"; >> index.php
                    echo echo "üßÆ CALCULATIONS:\\n"; >> index.php
                    echo echo "10 + 5 = " . (10 + 5) . "\\n"; >> index.php
                    echo echo "20 - 8 = " . (20 - 8) . "\\n"; >> index.php
                    echo echo "6 * 7 = " . (6 * 7) . "\\n"; >> index.php
                    echo echo "100 / 25 = " . (100 / 25) . "\\n"; >> index.php
                    echo echo "\\n"; >> index.php
                    echo echo "‚úÖ TUGAS 2 COMPLETED!\\n"; >> index.php
                    echo echo "‚úÖ powershell \\"php index.php\\" executed!\\n"; >> index.php
                    echo echo "=================================\\n"; >> index.php
                    echo ?^> >> index.php
                '''
                
                echo '‚úÖ index.php created successfully!'
            }
        }
        
        stage('3. Run PHP Script - TUGAS 2') {
            steps {
                echo 'üéØ ================================'
                echo 'üéØ TUGAS 2: RUN PHP SCRIPT'
                echo 'üéØ ================================'
                echo 'üìå Executing: powershell "php index.php"'
                
                // Run PHP using PowerShell (Windows)
                powershell '''
                    Write-Host "=== TUGAS 2: PHP EXECUTION ===" -ForegroundColor Cyan
                    Write-Host "Command: php index.php" -ForegroundColor Yellow
                    Write-Host "--------------------------------" -ForegroundColor Gray
                    
                    php index.php
                    
                    if ($LASTEXITCODE -eq 0) {
                        Write-Host "`n‚úÖ TUGAS 2: SUCCESS!" -ForegroundColor Green
                        Write-Host "‚úÖ Requirement: powershell 'php index.php' - COMPLETED!" -ForegroundColor Green
                    } else {
                        Write-Host "`n‚ùå PHP script failed!" -ForegroundColor Red
                        exit 1
                    }
                '''
            }
        }
        
        stage('4. Simple Unit Test') {
            steps {
                echo 'üß™ ================================'
                echo 'üß™ TUGAS 3: SIMPLE UNIT TEST'
                echo 'üß™ ================================'
                
                // Create simple test file
                bat '''
                    echo ^<?php > test.php
                    echo // Simple test for CI/CD >> test.php
                    echo function testAddition(\$a, \$b) { >> test.php
                    echo     return \$a + \$b; >> test.php
                    echo } >> test.php
                    echo >> test.php
                    echo echo "Simple Test:\\n"; >> test.php
                    echo echo "5 + 3 = " . testAddition(5, 3) . "\\n"; >> test.php
                    echo echo "Test passed!\\n"; >> test.php
                    echo ?^> >> test.php
                '''
                
                // Run test
                powershell '''
                    Write-Host "=== RUNNING SIMPLE TEST ===" -ForegroundColor Magenta
                    php test.php
                    Write-Host "`n‚úÖ Simple test completed!" -ForegroundColor Green
                '''
            }
        }
        
        stage('5. Generate Report') {
            steps {
                echo 'üìä ================================'
                echo 'üìä GENERATING CI/CD REPORT'
                echo 'üìä ================================'
                
                bat '''
                    echo # CI/CD PIPELINE EXECUTION REPORT > report.md
                    echo ## TUGAS CI/CD - COMPLETED >> report.md
                    echo ### Repository: citrasn/citrasn >> report.md
                    echo ### Build Time: %date% %time% >> report.md
                    echo >> report.md
                    echo ## ‚úÖ TUGAS YANG DISELESAIKAN: >> report.md
                    echo 1. **GitHub Webhook + NGROK** >> report.md
                    echo 2. **Run PHP Script** - powershell "php index.php" >> report.md
                    echo 3. **Simple Unit Test** - Basic PHP testing >> report.md
                    echo >> report.md
                    echo ## üìÅ FILES CREATED: >> report.md
                    echo - Jenkinsfile (Pipeline configuration) >> report.md
                    echo - index.php (PHP script for Tugas 2) >> report.md
                    echo - test.php (Simple unit test) >> report.md
                    echo - report.md (This report) >> report.md
                    echo >> report.md
                    echo *Report generated automatically by Jenkins Windows Pipeline* >> report.md
                '''
                
                // Show report
                powershell '''
                    Write-Host "=== CI/CD REPORT ===" -ForegroundColor Green
                    Get-Content report.md
                    Write-Host "=====================" -ForegroundColor Green
                '''
            }
        }
    }
    
    post {
        always {
            echo '================================'
            echo 'üèÅ PIPELINE EXECUTION COMPLETE'
            echo '================================'
            echo 'üîó GitHub: https://github.com/citrasn/citrasn'
            echo 'üîó NGROK: https://colligative-steellike-ophelia.ngrok-free.dev'
            echo 'üíª OS: Windows'
            
            // List final files
            bat '''
                echo ================================
                echo FINAL FILES IN WORKSPACE
                echo ================================
                dir /B
                echo ================================
            '''
        }
        
        success {
            echo 'üéâ ================================'
            echo 'üéâ ‚úÖ CI/CD PIPELINE BERHASIL!'
            echo 'üéâ ================================'
            echo ''
            echo 'üìã ALL TASKS COMPLETED:'
            echo '1. ‚úÖ GitHub Webhook + NGROK'
            echo '2. ‚úÖ Run PHP Script (powershell)'
            echo '3. ‚úÖ Simple Unit Test'
            echo ''
            echo 'üéØ SEMUA REQUIREMENTS TUGAS TERCAPAI!'
        }
        
        failure {
            echo '‚ùå PIPELINE FAILED - Check errors above'
        }
    }
}
EOF