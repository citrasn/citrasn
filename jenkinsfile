pipeline {
    agent any
    
    stages {
        stage('1. Checkout Code') {
            steps {
                echo 'üöÄ STARTING CI/CD PIPELINE'
                echo 'üì¶ Repository: citrasn/citrasn'
                echo 'üíª OS: Windows'
                
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/citrasn/citrasn.git'
                    ]]
                ])
                
                bat '''
                    echo ============================
                    echo WORKSPACE FILES
                    echo ============================
                    dir /B
                    echo ============================
                '''
            }
        }
        
        stage('2. Create PHP File') {
            steps {
                echo 'üìù CREATING index.php FOR TUGAS 2'
                
                bat '''
                    echo ^<?php > index.php
                    echo echo "================================"; >> index.php
                    echo echo "    CI/CD PIPELINE - TUGAS 2"; >> index.php
                    echo echo "================================"; >> index.php
                    echo echo "Repository: citrasn/citrasn"; >> index.php
                    echo echo "Time: " . date("Y-m-d H:i:s"); >> index.php
                    echo echo "PHP Version: " . PHP_VERSION; >> index.php
                    echo echo "================================"; >> index.php
                    echo echo ""; >> index.php
                    echo echo "TUGAS 2: Run PHP Script"; >> index.php
                    echo echo "Command: powershell 'php index.php'"; >> index.php
                    echo echo ""; >> index.php
                    echo echo "=== CALCULATIONS ==="; >> index.php
                    echo echo "15 + 7 = " . (15 + 7); >> index.php
                    echo echo "20 - 9 = " . (20 - 9); >> index.php
                    echo echo "6 * 8 = " . (6 * 8); >> index.php
                    echo echo "100 / 4 = " . (100 / 4); >> index.php
                    echo echo ""; >> index.php
                    echo echo "‚úÖ TUGAS 2 COMPLETED!"; >> index.php
                    echo echo "================================"; >> index.php
                    echo ?^> >> index.php
                '''
            }
        }
        
        stage('3. Run PHP - TUGAS 2') {
            steps {
                echo 'üéØ EXECUTING TUGAS 2: powershell "php index.php"'
                
                powershell '''
                    Write-Host "=== RUNNING PHP SCRIPT ===" -ForegroundColor Cyan
                    Write-Host "Command: php index.php" -ForegroundColor Yellow
                    Write-Host "--------------------------" -ForegroundColor Gray
                    
                    php index.php
                    
                    Write-Host "`n‚úÖ PHP SCRIPT EXECUTED SUCCESSFULLY!" -ForegroundColor Green
                    Write-Host "‚úÖ TUGAS 2 REQUIREMENT MET!" -ForegroundColor Green
                '''
            }
        }
        
        stage('4. Create Test File') {
            steps {
                echo 'üß™ CREATING TEST FILE FOR TUGAS 3'
                
                bat '''
                    echo ^<?php > test.php
                    echo // Simple test for CI/CD >> test.php
                    echo echo "Simple PHP Test\\n"; >> test.php
                    echo echo "5 + 3 = " . (5 + 3) . "\\n"; >> test.php
                    echo echo "Test completed!\\n"; >> test.php
                    echo ?^> >> test.php
                '''
                
                powershell '''
                    Write-Host "=== RUNNING TEST ===" -ForegroundColor Magenta
                    php test.php
                    Write-Host "`n‚úÖ TEST COMPLETED!" -ForegroundColor Green
                '''
            }
        }
        
        stage('5. Final Report') {
            steps {
                echo 'üìä GENERATING FINAL REPORT'
                
                bat '''
                    echo # CI/CD PIPELINE EXECUTION REPORT > report.txt
                    echo ================================= >> report.txt
                    echo CI/CD PIPELINE - SUCCESS >> report.txt
                    echo ================================= >> report.txt
                    echo Repository: citrasn/citrasn >> report.txt
                    echo Build Time: %date% %time% >> report.txt
                    echo >> report.txt
                    echo TUGAS COMPLETED: >> report.txt
                    echo 1. GitHub Webhook + NGROK >> report.txt
                    echo 2. Run PHP Script (powershell) >> report.txt
                    echo 3. Simple PHP Test >> report.txt
                    echo >> report.txt
                    echo Status: SUCCESS >> report.txt
                    echo ================================= >> report.txt
                '''
                
                bat 'type report.txt'
            }
        }
    }
    
    post {
        always {
            echo 'üèÅ PIPELINE EXECUTION FINISHED'
            bat 'echo GitHub: https://github.com/citrasn/citrasn'
            bat 'echo Jenkins: https://colligative-steellike-ophelia.ngrok-free.dev'
        }
        success {
            echo '‚úÖ ‚úÖ ‚úÖ CI/CD PIPELINE BERHASIL! ‚úÖ ‚úÖ ‚úÖ'
            echo '‚úÖ TUGAS 2: powershell "php index.php" - DONE!'
            echo '‚úÖ TUGAS 3: Simple testing - DONE!'
            echo '‚úÖ ALL REQUIREMENTS COMPLETED!'
        }
    }
}
